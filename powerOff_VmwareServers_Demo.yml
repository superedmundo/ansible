---
- name: Conectar a ESXi y apagar una máquina virtual
  hosts: 10.57.23.142  # Cambia 'esxi_server' por el nombre de tu servidor ESXi o su dirección IP
  gather_facts: no 
  vars_files:
  - "./oscarc_otobo_password"
  vars:
    hostname: "10.57.23.142"
    username: "root"
    password: "Ditra.Poc2021"
    vm_ids: 
      - ActiveDirectory2012R2: 63
      - WindowsServer-Clon-01: 70
      - WindowsServer-Clon-02: 71

  tasks:
    - name: Conectar a ESXi
      vmware_vm_shell:
        hostname: "{{ hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
        insecure: yes  # Esto permite conexiones no seguras (ajusta según sea necesario)
        validate_certs: no  # Esto desactiva la validación de certificados SSL (ajusta según sea necesario)
        timeout: 60
        cmd: "vim-cmd vmsvc/power.shutdown 70"  # Cambia "{{ vm_id }}" por el ID de la máquina virtual que deseas apagar
      delegate_to: localhost
      #loop: vm_ids
      register: result

    - name: Verificar el resultado
      debug:
        var: result.stdout_lines
