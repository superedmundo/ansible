---
- name: Add a user in Active Directory
  hosts: 10.100.1.116
  gather_facts: no 
  collections:
    - ditra.cisco

  vars:
    enabled: null
    user_cannot_change_password: null
    nombre: null
    password: null
    state: present
    groups_to_add: null
    c: null
    codePage: null
    comment: null
    company: null
    department: null
    departmentNumber: null
    description: null
    displayName:  null
    division:  null
    employeeID:  null
    employeeNumber:  null
    employeeType:  null
    facsimileTelephoneNumber:  null
    givenName:  null
    homePhone:  null
    info:  null
    initials:  null
    ipPhone:  null
    l:  null
    mail:  null
    middleName:  null
    mobile:  null
    pager:  null
    personalTitle:  null
    physicalDeliveryOfficeName:  null
    postalAddress:  null
    postalCode:  null
    postOfficeBox:  null
    sn:  null
    st:  null
    street:  null
    streetAddress:  null
    telephoneNumber:  null
    title:  null
    userPrincipalName:  null
    wWWHomePage:  null

    # NOTIFICACIONES
    # Sms 
    # On Success
    notification_sms_on_success: null
    notification_sms_send_user_credentials: null
    # on ERROR
    notification_sms_on_fail: null

    # Email
    # On Success
    notification_email_on_success: null
    notification_email_send_user_credentials: null
    # on ERROR
    notification_email_on_fail: null

  tasks:
    - name: Queryng "{{ nombre }}" 
      when: nombre is defined
      community.windows.win_domain_user:
        name: "{{ nombre }}"
        state: query
      register: result_query 

    - name: Establecer el valor de result_query como result
      ansible.builtin.set_fact:
        result: "{{ result_query }}"   

    - name: Add User because is absent
      when: result.state == "absent"
      block:
        - name: Add user in AD
          microsoft.ad.user:
            #name: "{{ nombre }}"
            password: "{{ password }}"
            state: present
            attributes:
              set:
                userPrincipalName: "{{ userPrincipalName }}"
          register: result_add_user

        - name: Queryng Again "{{ nombre }}" 
          when: nombre is defined
          community.windows.win_domain_user:
            name: "{{ nombre }}"
            state: query
          register: result_query 

        - name: Establecer el valor de result_query como result
          ansible.builtin.set_fact:
            result: "{{ result_query }}"   

    - name: Modify User because is present
      when: result.state == "present"
      block:
        - name: Modify enabled user in AD
          when: enabled is defined
          microsoft.ad.user:
            enabled: "{{ enabled }}"
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present

        - name: Modify user_cannot_change_password user in AD
          when: user_cannot_change_password is defined
          microsoft.ad.user:
            #enabled: "{{ (enabled) | ternary(enabled, result.enabled) }}" # "{{ enabled }}"
            user_cannot_change_password: "{{ user_cannot_change_password }}"
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            #password:  "{{ (password) | ternary(password, 'D1tr4.2o22') }}" #"{{ password }}"
            state:  present
            #groups:
              #set:  "{{ (groups_to_add) | ternary(groups_to_add, result.groups_to_add) }}" #"{{ groups_to_add }}"
            #attributes:
              #set:
                #accountExpires:  "{{ (accountExpires) | ternary(accountExpires, '') }}"
                #c: "{{ (c) | ternary(c, result.country) }}"  #"{{ c }}"
                #codePage: "{{ (codePage) | ternary(codePage, '') }}"  #  "{{ codePage }}"
                #comment: "{{ (comment) | ternary(comment, '') }}"  #  "{{ comment }}"
                #company: "{{ (company) | ternary(company, result.company) }}"  # 
                #department: "{{ (department) | ternary(department, '') }}"  #  "{{ department }}"
                #departmentNumber: "{{ (departmentNumber) | ternary(departmentNumber, '') }}"  #  "{{ departmentNumber }}"
                #description: "{{ (description) | ternary(description, result.description) }}"  #  "{{ description }}"
                #displayName: "{{ (displayName) | ternary(displayName, result.displayName) }}"  #  "{{ displayName }}"
                #division: "{{ (division) | ternary(division, '') }}"  #  "{{ division }}"
                #employeeID: "{{ (employeeID) | ternary(employeeID, '') }}"  #  "{{ employeeID }}"
                #employeeNumber: "{{ (employeeNumber) | ternary(employeeNumber, '') }}"  #  "{{ employeeNumber }}"
                #employeeType: "{{ (employeeType) | ternary(employeeType, '') }}"  #  "{{ employeeType }}"
                #facsimileTelephoneNumber: "{{ (facsimileTelephoneNumber) | ternary(facsimileTelephoneNumber, '') }}"  #  "{{ facsimileTelephoneNumber }}"
                #givenName: "{{ (givenName) | ternary(givenName, result.firstname) }}"  #  "{{ givenName }}"
                #homePhone: "{{ (homePhone) | ternary(homePhone, '') }}"  #  "{{ homePhone }}"
                #info: "{{ (info) | ternary(info, '') }}"  #  "{{ info }}"
                #initials: "{{ (initials) | ternary(initials, '') }}"  #  "{{ initials }}"
                #ipPhone: "{{ (ipPhone) | ternary(ipPhone, '') }}"  #  "{{ ipPhone }}"
                #l: "{{ (l) | ternary(l, result.city) }}"  #  "{{ l }}"
                #mail: "{{ (mail) | ternary(mail, result.mail) }}"  #  "{{ mail }}"
                #middleName: "{{ (middleName) | ternary(middleName, '') }}"  #  "{{ middleName }}"
                #mobile: "{{ (mobile) | ternary(mobile, '') }}"  #  "{{ mobile }}"
                #pager: "{{ (pager) | ternary(pager, '') }}"  #  "{{ pager }}"
                #personalTitle: "{{ (personalTitle) | ternary(personalTitle, '') }}"  #  "{{ personalTitle }}"
                #physicalDeliveryOfficeName: "{{ (physicalDeliveryOfficeName) | ternary(physicalDeliveryOfficeName, '') }}"  #  "{{ physicalDeliveryOfficeName }}"
                #postalAddress: "{{ (postalAddress) | ternary(postalAddress, '') }}"  #  "{{ postalAddress }}"
                #postalCode: "{{ (postalCode) | ternary(postalCode, result.postal_code) }}"  #  "{{ postalCode }}"
                #postOfficeBox: "{{ (postOfficeBox) | ternary(postOfficeBox, '') }}"  #  "{{ postOfficeBox }}"
                #sn: "{{ (sn) | ternary(sn, result.surname) }}"  #  "{{ sn }}"
                #st: "{{ (st) | ternary(st, result.state_province) }}"  #  "{{ st }}"
                #street: "{{ (street) | ternary(street, result.street) }}"  #  "{{ street }}"
                #streetAddress: "{{ (streetAddress) | ternary(streetAddress, '') }}"  #  "{{ streetAddress }}"
                #telephoneNumber: "{{ (telephoneNumber) | ternary(telephoneNumber, '') }}"  #  "{{ telephoneNumber }}"
                #title: "{{ (title) | ternary(title, '') }}"  #  "{{ title }}"
                #userPrincipalName: "{{ (userPrincipalName) | ternary(userPrincipalName, result.upn) }}"  #  "{{ userPrincipalName }}"
                #wWWHomePage: "{{ (wWWHomePage) | ternary(wWWHomePage, '') }}"  #  "{{ wWWHomePage }}"

        - name: Modify password user in AD
          when: password is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            password: "{{ password }}"
        
        - name: Modify groups_to_add user in AD
          when: groups_to_add is defined
          microsoft.ad.user:
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:  present
            groups:
              set:  "{{ groups_to_add }}" 

        - name: Modify c user in AD
          when: c is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                c: "{{ c }}"

        - name: Modify codePage user in AD
          when: codePage is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                codePage: "{{ codePage }}"

        - name: Modify comment user in AD
          when: comment is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                comment: "{{ comment }}"

        - name: Modify company user in AD
          when: company is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                company: "{{ company }}"

        - name: Modify department user in AD
          when: department is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                department: "{{ department }}"

        - name: Modify departmentNumber user in AD
          when: departmentNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                departmentNumber: "{{ departmentNumber }}"

        - name: Modify description user in AD
          when: description is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                description: "{{ description }}"

        - name: Modify displayName user in AD
          when: displayName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                displayName: "{{ displayName }}"

        - name: Modify division user in AD
          when: division is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                division: "{{ division }}"

        - name: Modify employeeID user in AD
          when: employeeID is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeID: "{{ employeeID }}"

        - name: Modify employeeNumber user in AD
          when: employeeNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeNumber: "{{ employeeNumber }}"

        - name: Modify employeeType user in AD
          when: employeeType is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeType: "{{ employeeType }}"

        - name: Modify facsimileTelephoneNumber user in AD
          when: facsimileTelephoneNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                facsimileTelephoneNumber: "{{ facsimileTelephoneNumber }}"

        - name: Modify givenName user in AD
          when: givenName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                givenName: "{{ givenName }}"

        - name: Modify homePhone user in AD
          when: homePhone is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                homePhone: "{{ homePhone }}"

        - name: Modify info user in AD
          when: info is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                info: "{{ info }}"

        - name: Modify initials user in AD
          when: initials is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                initials: "{{ initials }}"

        - name: Modify ipPhone user in AD
          when: ipPhone is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                ipPhone: "{{ ipPhone }}"

        - name: Modify l user in AD
          when: l is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                l: "{{ l }}"

        - name: Modify mail user in AD
          when: mail is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                mail: "{{ mail }}"

        - name: Modify middleName user in AD
          when: middleName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                middleName: "{{ middleName }}"

        - name: Modify mobile user in AD
          when: mobile is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                mobile: "{{ mobile }}"

        - name: Modify pager user in AD
          when: pager is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                pager: "{{ pager }}"

        - name: Modify personalTitle user in AD
          when: personalTitle is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                personalTitle: "{{ personalTitle }}"

        - name: Modify physicalDeliveryOfficeName user in AD
          when: physicalDeliveryOfficeName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                physicalDeliveryOfficeName: "{{ physicalDeliveryOfficeName }}"

        - name: Modify postalAddress user in AD
          when: postalAddress is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postalAddress: "{{ postalAddress }}"

        - name: Modify postalCode user in AD
          when: postalCode is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postalCode: "{{ postalCode }}"

        - name: Modify postOfficeBox user in AD
          when: postOfficeBox is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postOfficeBox: "{{ postOfficeBox }}"

        - name: Modify sn user in AD
          when: sn is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                sn: "{{ sn }}"

        - name: Modify st user in AD
          when: st is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                st: "{{ st }}"

        - name: Modify street user in AD
          when: street is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                street: "{{ street }}"

        - name: Modify streetAddress user in AD
          when: streetAddress is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                streetAddress: "{{ streetAddress }}"

        - name: Modify telephoneNumber user in AD
          when: telephoneNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                telephoneNumber: "{{ telephoneNumber }}"

        - name: Modify title user in AD
          when: title is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                title: "{{ title }}"

        #- name: Modify userPrincipalName user in AD
        #  when: userPrincipalName is defined
        #  microsoft.ad.user:
        #    name:     "{{ result.name }}"
        #    identity: "{{ result.distinguished_name }}"
        #    state:    present
        #    attributes:
        #      set:
        #        userPrincipalName: "{{ userPrincipalName }}"

        - name: Modify wWWHomePage user in AD
          when: wWWHomePage is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                wWWHomePage: "{{ wWWHomePage }}"

    # NOTIFICACIONES
    - name: Send notification_email_on_success
      when: notification_email_on_success is defined
      ansible.builtin.include_role:
        name: ditra.cisco.send_email
        apply:
          delegate_to: localhost
      vars:
        subject: La alta del usuario fue exitosa
        body: |
          Todo super bien

        to_email: "{{ notification_email_on_success }}"
        alert: true
        
    - name: Send notification_email_on_fail
      when: notification_email_on_fail is defined
      ansible.builtin.include_role:
        name: ditra.cisco.send_email
        apply:
          delegate_to: localhost
      vars:
        subject: La alta del usuario fue fallida
        body: |
          Todo super mal

        to_email: "{{ notification_email_on_fail }}"
        alert: true
        