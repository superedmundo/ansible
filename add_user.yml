---
- name: Add a user in Active Directory
  hosts: 10.100.1.116
  gather_facts: no 
  vars_files:
    - "./oscarc_otobo_password"
  collections:
    - ditra.cisco
    - ansible.builtin.password

  vars:
    enabled: true
    sAMAccountName: null
    password: null
    generated_password: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits', 'punctuation'], length=12) }}"
    dominio: Contoso.mx
    user_cannot_change_password: false
    AddMailbox: false
    AddMailbox365: false

    # NOTIFICACIONES
    # Sms 
    # On Success
    notification_sms_on_success: null
    notification_sms_send_user_credentials: null

    # Email
    # On Success
    notification_email: null
    notification_email_send_user_credentials: null

    # Variables internas de control de flujo
    something_wrong: false

    # vars for otobo changes
    validate_certs: false
    otobo_user: baltadlakd
    base_url: https://10.100.1.124/otobo/nph-genericinterface.pl/Webservice
    module:
      login: /care
      cmdb: /CMDB/ConfigItem
    path:
      login: "{{ base_url }}{{ module.login }}/login"
      Ticket: "{{ base_url }}{{ module.login }}/Ticket"
    TicketID: null

  tasks:

  # tasks to update status in oboto
    - name: Otobo login, get session id
      delegate_to: localhost
      ansible.builtin.uri:
        url: "{{ path.login }}"
        method: POST
        body_format: json
        body:
          UserLogin: "{{ otobo_user }}"
          Password: "{{ otobo_password }}"
        validate_certs: "{{ validate_certs }}"
        return_content: true
      register: response

    - name: Get SessionID from login response
      ansible.builtin.set_fact:
        session_id: "{{ r.SessionID }}"
      vars:
        r: "{{ response.content | from_json }}"
      delegate_to: localhost
    
    - name: Set auto process ticket as processing status
      delegate_to: localhost
      ansible.builtin.uri:
        url: "{{ path.Ticket }}/{{ TicketID }}/Update"
        method: POST
        body_format: json
        body:
          SessionID: "{{ session_id }}"
          TicketID: "{{ TicketID }}"
          DynamicField:
           - Name: AutoStatus
             Value: processing

        validate_certs: "{{ validate_certs }}"
        return_content: true
      register: response
      failed_when: "response.status != 200"
      run_once: true
      when: TicketID is not none and session_id is defined

  # Desplegando las variables que llegaron

    - name: Desplegando las variables que llegaron.
      ansible.builtin.debug:
        msg: 
          sAMAccountName: "{{ sAMAccountName }}" 
          password: "{{ password }}"
          generated_password: "{{ generated_password }}"
          AddMailbox: "{{ AddMailbox }}"

          # NOTIFICACIONES
          # Email
          # On Success
          notification_email: "{{ notification_email }}"
          notification_email_send_user_credentials: "{{ notification_email_send_user_credentials }}"

  # Revisando si ya existe o no el ususario en el AD

    - name: Queryng "{{ sAMAccountName }}" 
      block:
        - name: Queryng "{{ sAMAccountName }}" 
          when: sAMAccountName is defined
          community.windows.win_domain_user:
            name: "{{ sAMAccountName }}"
            state: query
          register: result_query 

        - name: Establecer el valor de result_query como result
          ansible.builtin.set_fact:
            result: "{{ result_query }}"   
      
      rescue: 
        - name: Envio de correo failed
          when: notification_email is defined
          ansible.builtin.include_role:
            name: ditra.cisco.send_email
            apply:
              delegate_to: localhost
          vars:
            subject: Ocurrió un error en la búsqueda de la cuenta en AD
            body: |
              ansible_failed_task: "{{ ansible_failed_task | to_json(indent=2) }}"
              ansible_failed_result: "{{ ansible_failed_result | to_json(indent=2) }}" 

            to_email: "{{ notification_email }}"
            alert: true         

        - name: Establecer el valor de algo Erroneo
          ansible.builtin.set_fact:
            something_wrong: true

  # Revisando que no exista ya el usuario
    - name: Asegurando que NO exista ya el usuario
      when: result.state == "present"
      block:
        - name: Establecer el valor de algo Erroneo
          ansible.builtin.set_fact:
            something_wrong: true

  # Agregando al usuario por que no existe

    - name: Add User because is absent
      when: result.state == "absent" and something_wrong == false
      block:
        - name: add user in ad
          microsoft.ad.user:
            name: "{{ sAMAccountName }}"
            password: "{{ (password) | ternary(password, generated_password) }}"
            state: present
            attributes:
              set:
                userPrincipalName: "{{ sAMAccountName }}@{{ dominio }}"
          register: result_add_user

        - name: Desplegando el resultado del Add.
          ansible.builtin.debug:
            var:  result_add_user

        - name: Queryng Again "{{ sAMAccountName }}" 
          when: sAMAccountName is defined
          community.windows.win_domain_user:
            name: "{{ sAMAccountName }}"
            state: query
          register: result_query 

        - name: Establecer el valor de result_query como result
          ansible.builtin.set_fact:
            result: "{{ result_query }}"   
      
      rescue: 
        - name: Envio de correo failed al no poder crear el usuario
          when: notification_email is defined and something_wrong == true
          ansible.builtin.include_role:
            name: ditra.cisco.send_email
            apply:
              delegate_to: localhost
          vars:
            subject: Ocurrió un error en la alta de la cuenta de AD
            body: |
              result_add_user: "{{ result_add_user | to_json(indent=2) }}" 

              ***********
              ansible_failed_task: "{{ ansible_failed_task | to_json(indent=2) }}" 

              ***********
              ansible_failed_result: "{{ ansible_failed_result | to_json(indent=2) }}" 

            to_email: "{{ notification_email }}"
            alert: true

        - name: Desplegando la variable de ansible_facts.
          ansible.builtin.debug:
            msg: 
              ansible_facts: "{{ ansible_facts | to_json(indent=2) }}"          

        - name: Establecer el valor de algo Erroneo
          ansible.builtin.set_fact:
            something_wrong: true

  # Modificando al usuario por que ya existe o por que ya fue creado

    - name: Modify User because is present
      when: result.state == "present" and something_wrong == false
      block:
        - name: Entrando al bloque de Modificación
          ansible.builtin.debug:
            msg: 
              result.state: "{{ result.state }}" 
              result_add_user: "{{ result_add_user }}"
              result_add_user_is_defined: "{{ result_add_user is defined }}"
              result_add_user.changed_is_defined: "{{ result_add_user.changed is defined }}"
              result_add_user.failed_is_defined: "{{ result_add_user.failed is defined }}"
              result_add_user.changed: "{{ result_add_user.changed }}"
              
        - name: Modify enabled user in AD
          when: enabled is defined and result.enabled != enabled
          microsoft.ad.user:
            enabled: "{{ enabled }}"
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present

        - name: Modify user_cannot_change_password user in AD
          when: user_cannot_change_password is defined and result.user_cannot_change_password != user_cannot_change_password
          microsoft.ad.user:
            user_cannot_change_password: "{{ user_cannot_change_password }}"
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:  present

        - name: Modify password user in AD
          when: (password is defined or generated_password is defined) and something_wrong == false
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            password: "{{ (password) | ternary(password, generated_password) }}"
        
        - name: Modify groups_to_add user in AD
          when: groups_to_add is defined
          microsoft.ad.user:
            name: "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:  present
            groups:
              set:  "{{ groups_to_add }}" 

        - name: Modify c user in AD
          when: c is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                c: "{{ c }}"

        - name: Modify codePage user in AD
          when: codePage is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                codePage: "{{ codePage }}"

        - name: Modify comment user in AD
          when: comment is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                comment: "{{ comment }}"

        - name: Modify company user in AD
          when: company is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                company: "{{ company }}"

        - name: Modify department user in AD
          when: department is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                department: "{{ department }}"

        - name: Modify departmentNumber user in AD
          when: departmentNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                departmentNumber: "{{ departmentNumber }}"

        - name: Modify description user in AD
          when: description is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                description: "{{ description }}"

        - name: Modify displayName user in AD
          when: displayName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                displayName: "{{ displayName }}"

        - name: Modify division user in AD
          when: division is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                division: "{{ division }}"

        - name: Modify employeeID user in AD
          when: employeeID is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeID: "{{ employeeID }}"

        - name: Modify employeeNumber user in AD
          when: employeeNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeNumber: "{{ employeeNumber }}"

        - name: Modify employeeType user in AD
          when: employeeType is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                employeeType: "{{ employeeType }}"

        - name: Modify facsimileTelephoneNumber user in AD
          when: facsimileTelephoneNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                facsimileTelephoneNumber: "{{ facsimileTelephoneNumber }}"

        - name: Modify givenName user in AD
          when: givenName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                givenName: "{{ givenName }}"

        - name: Modify homePhone user in AD
          when: homePhone is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                homePhone: "{{ homePhone }}"

        - name: Modify info user in AD
          when: info is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                info: "{{ info }}"

        - name: Modify initials user in AD
          when: initials is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                initials: "{{ initials }}"

        - name: Modify ipPhone user in AD
          when: ipPhone is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                ipPhone: "{{ ipPhone }}"

        - name: Modify l user in AD
          when: l is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                l: "{{ l }}"

        - name: Modify mail user in AD
          when: mail is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                mail: "{{ mail }}"

        - name: Modify middleName user in AD
          when: middleName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                middleName: "{{ middleName }}"

        - name: Modify mobile user in AD
          when: mobile is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                mobile: "{{ mobile }}"

        - name: Modify pager user in AD
          when: pager is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                pager: "{{ pager }}"

        - name: Modify personalTitle user in AD
          when: personalTitle is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                personalTitle: "{{ personalTitle }}"

        - name: Modify physicalDeliveryOfficeName user in AD
          when: physicalDeliveryOfficeName is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                physicalDeliveryOfficeName: "{{ physicalDeliveryOfficeName }}"

        - name: Modify postalAddress user in AD
          when: postalAddress is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postalAddress: "{{ postalAddress }}"

        - name: Modify postalCode user in AD
          when: postalCode is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postalCode: "{{ postalCode }}"

        - name: Modify postOfficeBox user in AD
          when: postOfficeBox is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                postOfficeBox: "{{ postOfficeBox }}"

        - name: Modify sn user in AD
          when: sn is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                sn: "{{ sn }}"

        - name: Modify st user in AD
          when: st is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                st: "{{ st }}"

        - name: Modify street user in AD
          when: street is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                street: "{{ street }}"

        - name: Modify streetAddress user in AD
          when: streetAddress is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                streetAddress: "{{ streetAddress }}"

        - name: Modify telephoneNumber user in AD
          when: telephoneNumber is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                telephoneNumber: "{{ telephoneNumber }}"

        - name: Modify title user in AD
          when: title is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                title: "{{ title }}"

        - name: Modify wWWHomePage user in AD
          when: wWWHomePage is defined
          microsoft.ad.user:
            name:     "{{ result.name }}"
            identity: "{{ result.distinguished_name }}"
            state:    present
            attributes:
              set:
                wWWHomePage: "{{ wWWHomePage }}"


  # Crear Facts para la creación del buzón de Office 365
    - name: Crear Facts para la creación del buzón de Office 365
      when: AddMailbox == '1'
      ansible.builtin.set_fact:
        # Variables para el mailbox
        AddMailbox365: true
        displayName365: null
        microsoftOnlineServicesID365: null
        mailboxPlan365: null
        # Variable de notificación
        notification_email365: "{{notification_email}}"
        # Variables de conexión
        AppId365: "d8f14294-5e13-4d85-9e95-e491958c95cf"
        CertificateThumbprint365: "8A27C95763FD75AA575E75DB556DFEC6B9F7A899"
        Organization365: "ditramx0.onmicrosoft.com"

  # NOTIFICACIONES
  # Crear mensaje para Notificación
    - name: Crear mensaje notificación exitosa
      when: something_wrong == false
      ansible.builtin.set_fact:
        result_process: "Se creó de manera exitosa la cuenta: {{ sAMAccountName }}"

    - name: Crear mensaje notificación fallida
      when: something_wrong == true
      ansible.builtin.set_fact:
        result_process: "Ocurrió un error no fue posible crear la cuenta: {{ sAMAccountName }}"

    - name: Send notification_email
      when: notification_email is defined and something_wrong == false
      ansible.builtin.include_role:
        name: ditra.cisco.send_email
        apply:
          delegate_to: localhost
      vars:
        subject: La alta del usuario fue exitosa
        body: |
          Todo super bien

        to_email: "{{ notification_email }}"
        alert: true
        
    - name: Send notification_email_send_user_credentials
      when: notification_email_send_user_credentials is defined and result_add_user.changed == true and result_add_user.failed == false
      ansible.builtin.include_role:
        name: ditra.cisco.send_email
        apply:
          delegate_to: localhost
      vars:
        subject: La alta del usuario fue exitosa
        body: |
         
          AccountName: "{{ sAMAccountName }}" 
          password: "{{ (password) | ternary(password, generated_password) }}"
          identity: "{{ result.distinguished_name }}"
          
  
        to_email: "{{ notification_email_send_user_credentials }}"
        alert: true
        
    - name: Send notification_email_on_fail
      when: notification_email is defined and something_wrong == true
      ansible.builtin.include_role:
        name: ditra.cisco.send_email
        apply:
          delegate_to: localhost
      vars:
        subject: La alta del usuario fue fallida
        body: |
          Algo salió mal, revisa la bitácora

        to_email: "{{ notification_email }}"
        alert: true

  # Actualización del Ticket de Otobo
    - name: Post report to ticket on otobo
      delegate_to: localhost
      ansible.builtin.uri:
        url: "{{ path.Ticket }}/{{ TicketID }}/Update"
        method: POST
        body_format: json
        body:
          SessionID: "{{ session_id }}"
          TicketID: "{{ TicketID }}"
          Article:
            CommunicationChannel: Internal
            IsVisibleForCustomer: 1
            Subject: Reporte ansible
            Body: "{{ result_process }}"
            ContentType: text/plain; charset=utf-8
          DynamicField:
           - Name: AutoStatus
             Value: completed
        validate_certs: "{{ validate_certs }}"
        return_content: true
      register: response
      failed_when: "response.status != 200"
      run_once: true
      when: TicketID is not none and session_id is defined

- name: Set variables on an imported playbook
  when: something_wrong == false and AddMailbox365 is defined and AddMailbox365 == true
  ansible.builtin.import_playbook: add_mailbox365.yml
  vars:
    # Variables para el mailbox
    nombre: "{{ sAMAccountName }}"
    firstName: "{{ givenName }}"
    lastName: "{{ sn }}"
    displayName: null
    microsoftOnlineServicesID: null
    mailboxPlan: null
    # Variable de notificación
    notification_email: "{{ notification_email365 }}"
    # Variables de conexión
    AppId: "d8f14294-5e13-4d85-9e95-e491958c95cf"
    CertificateThumbprint: "8A27C95763FD75AA575E75DB556DFEC6B9F7A899"
    Organization: "ditramx0.onmicrosoft.com"
